{% extends "base.html" %}
{% block title %}Resultados de RegresiÃ³n LogÃ­stica{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
  <h1 class="text-center mb-4">ğŸ“Š Resultados de RegresiÃ³n LogÃ­stica</h1>

  <!-- MenÃº de navegaciÃ³n -->
  <ul class="nav nav-tabs mb-4 justify-content-center" id="seccionesTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="metrica-tab" data-bs-toggle="tab" data-bs-target="#metrica" type="button" role="tab" aria-controls="metrica" aria-selected="true">ğŸ“ˆ MÃ©tricas</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="predicciones-tab" data-bs-toggle="tab" data-bs-target="#predicciones" type="button" role="tab" aria-controls="predicciones" aria-selected="false">ğŸ“„ Predicciones</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="graficos-tab" data-bs-toggle="tab" data-bs-target="#graficos" type="button" role="tab" aria-controls="graficos" aria-selected="false">ğŸ“Š GrÃ¡ficos</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="exportar-tab" data-bs-toggle="tab" data-bs-target="#exportar" type="button" role="tab" aria-controls="exportar" aria-selected="false">ğŸ“¤ Exportar</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="filtrar-tab" data-bs-toggle="tab" data-bs-target="#filtrar" type="button" role="tab" aria-controls="filtrar" aria-selected="false">ğŸ” Datos individuales</button>
    </li>
  </ul>

  <div class="tab-content" id="seccionesTabsContent">

    <!-- SecciÃ³n MÃ©tricas -->
    <div class="tab-pane fade show active" id="metrica" role="tabpanel" aria-labelledby="metrica-tab">
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">ğŸ“ˆ MÃ©tricas del modelo</div>
        <div class="card-body">
          <ul>
            {% for key, value in resultados.metricas.items() %}
              <li><strong>{{ key }}:</strong> {{ "%.4f"|format(value) }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <!-- SecciÃ³n Predicciones -->
    <div class="tab-pane fade" id="predicciones" role="tabpanel" aria-labelledby="predicciones-tab">
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">ğŸ“„ Predicciones vs Valores reales</div>
        <div class="card-body">
          <div class="form-check form-check-inline">
            <input class="form-check-input pdf-item" type="checkbox" value="predicciones" checked>
            <label class="form-check-label">Incluir en PDF</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input excel-item" type="checkbox" value="predicciones" checked>
            <label class="form-check-label">Incluir en Excel</label>
          </div>
          <div class="table-responsive mt-3" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-bordered table-striped table-hover table-sm">
              <thead class="table-light">
                <tr>
                  {% for col in resultados.datos_predicciones.columns %}
                    <th>{{ col }}</th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                {% for _, row in resultados.datos_predicciones.iterrows() %}
                  <tr>
                    {% for col in resultados.datos_predicciones.columns %}
                      <td>{{ row[col] }}</td>
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- SecciÃ³n GrÃ¡ficos -->
    <div class="tab-pane fade" id="graficos" role="tabpanel" aria-labelledby="graficos-tab">
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">ğŸ“Š GrÃ¡ficos generados</div>
        <div class="card-body">
          <div class="form-check">
            <input class="form-check-input pdf-item" type="checkbox" value="roc" checked>
            <label class="form-check-label">Incluir ROC en PDF</label>
          </div>
          <div class="form-check">
            <input class="form-check-input pdf-item" type="checkbox" value="precision_recall" checked>
            <label class="form-check-label">Incluir Curva PrecisiÃ³n-Recall en PDF</label>
          </div>
          <div class="row mt-4">
            <div class="col-md-6 mb-3">
              <div class="card shadow">
                <div class="card-header">ğŸ“ˆ Curva ROC</div>
                <div class="card-body text-center">
                  <img src="{{ url_for('static', filename=resultados.grafico_roc) }}" class="img-fluid rounded" alt="Curva ROC">
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="card shadow">
                <div class="card-header">ğŸ“Š Curva PrecisiÃ³n-Recall</div>
                <div class="card-body text-center">
                  <img src="{{ url_for('static', filename=resultados.grafico_prec_rec) }}" class="img-fluid rounded" alt="Curva PrecisiÃ³n-Recall">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SecciÃ³n Exportar -->
    <div class="tab-pane fade" id="exportar" role="tabpanel" aria-labelledby="exportar-tab">
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">ğŸ“¤ Exportar resultados</div>
        <div class="card-body text-center">
          <form method="POST" action="{{ url_for('main.export_pdf') }}" id="form-pdf" class="d-inline-block me-3">
            <input type="hidden" name="items" id="pdf-items" />
            <button type="submit" class="btn btn-danger">ğŸ“„ Exportar PDF</button>
          </form>
          <form method="POST" action="{{ url_for('main.export_excel') }}" id="form-excel" class="d-inline-block">
            <input type="hidden" name="items" id="excel-items" />
            <button type="submit" class="btn btn-success">ğŸ“Š Exportar Excel</button>
          </form>
        </div>
      </div>
    </div>

    <!-- SecciÃ³n Datos individuales -->
    <div class="tab-pane fade" id="filtrar" role="tabpanel" aria-labelledby="filtrar-tab">
      <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">ğŸ” Filtrar por etiqueta de abandono</div>
        <div class="card-body">
          <form onsubmit="filtrarAbandono(event)">
            <div class="input-group mb-3">
              <label class="input-group-text" for="etiqueta_abandono">Selecciona:</label>
              <select class="form-select" id="etiqueta_abandono" name="etiqueta_abandono">
                <option value="SÃ­">SÃ­</option>
                <option value="No" selected>No</option>
              </select>
              <button class="btn btn-outline-primary" type="submit">Filtrar</button>
            </div>
          </form>

          <div class="table-responsive" id="tabla-filtrada" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
      </div>
    </div>

  </div>

  <div class="text-center mt-4">
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary">â† Volver</a>
  </div>
</div>

<script>
  // Filtrado dinÃ¡mico para datos individuales
  function filtrarAbandono(e) {
    if (e) e.preventDefault();

    const etiqueta = document.getElementById('etiqueta_abandono').value;
    const data = {{ resultados.datos_predicciones.to_json(orient="records") | tojson | safe }};

    const filtrados = data.filter(r => r.etiqueta_abandono === etiqueta);

    if (filtrados.length === 0) {
      document.getElementById('tabla-filtrada').innerHTML = "<p>No hay datos para esta etiqueta.</p>";
      return;
    }

    const columnas = Object.keys(filtrados[0]);
    let html = '<table class="table table-bordered table-hover table-sm"><thead><tr>';
    columnas.forEach(c => html += `<th>${c}</th>`);
    html += '</tr></thead><tbody>';
    filtrados.forEach(r => {
      html += '<tr>';
      columnas.forEach(c => html += `<td>${r[c]}</td>`);
      html += '</tr>';
    });
    html += '</tbody></table>';

    document.getElementById('tabla-filtrada').innerHTML = html;
  }

  // Export PDF/Excel: pasar opciones seleccionadas
  document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('form-pdf').addEventListener('submit', function (e) {
      const checks = document.querySelectorAll('.pdf-item:checked');
      const items = Array.from(checks).map(c => c.value);
      document.getElementById('pdf-items').value = JSON.stringify(items);
    });

    document.getElementById('form-excel').addEventListener('submit', function (e) {
      const checks = document.querySelectorAll('.excel-item:checked');
      const items = Array.from(checks).map(c => c.value);
      document.getElementById('excel-items').value = JSON.stringify(items);
    });

    // Inicializar filtro con datos
    filtrarAbandono();
  });
</script>

{% endblock %}
