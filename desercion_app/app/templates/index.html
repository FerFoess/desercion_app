{% extends "base.html" %}
{% block title %}Carga de Datos de Entrenamiento{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
  <h1 class="text-center mb-4">Carga de Datos de Entrenamiento</h1>

  <!-- Mensajes Flash - Mejorado para errores y √©xito -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Formulario Mejorado -->
<form action="{{ url_for('main.index') }}" method="post" enctype="multipart/form-data" class="card shadow p-4">
    <!-- Elimina form.hidden_tag() si no usas Flask-WTF -->

    <div class="mb-3">
      <label class="form-label"><strong>üìÅ Sube el archivo CSV:</strong></label>
      <input type="file" name="archivo_entrenamiento" class="form-control" accept=".csv" required>
    </div>
    
    <div class="text-center">
      <button type="submit" class="btn btn-primary">Cargar archivo</button>
    </div>
</form>

  <!-- Tabla de Datos - Validaci√≥n a√±adida -->
  {% if datos_paginados and columnas %}
  <div class="card shadow mt-5">
    <div class="card-header bg-info text-white fw-bold">
      üßæ Datos del archivo (p√°gina {{ pagina_actual }} de {{ total_paginas }})
    </div>
    <div class="card-body table-responsive">
      <table class="table table-striped table-bordered table-hover">
       <thead class="table-dark">
  <tr>
    {% for col in columnas %}
      <th>
        {{ col | capitalize }}
        <small class="text-muted d-block">{{ df[col].dtype if df else '' }}</small>
      </th>
    {% endfor %}
  </tr>
</thead>
        <tbody>
          {% for fila in datos_paginados %}
          <tr>
            {% for col in columnas %}
              <td>{{ fila.get(col, 'N/A') }}</td>  <!-- Usar .get() para evitar KeyError -->
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Paginaci√≥n Mejorada -->
      {% if total_paginas > 1 %}
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          <li class="page-item {% if pagina_actual == 1 %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('main.index', pagina=pagina_actual - 1) }}">&laquo; Anterior</a>
          </li>
          
          {% for p in range(1, total_paginas + 1) %}
            <li class="page-item {% if p == pagina_actual %}active{% endif %}">
              <a class="page-link" href="{{ url_for('main.index', pagina=p) }}">{{ p }}</a>
            </li>
          {% endfor %}
          
          <li class="page-item {% if pagina_actual == total_paginas %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('main.index', pagina=pagina_actual + 1) }}">Siguiente &raquo;</a>
          </li>
        </ul>
      </nav>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- Gr√°ficos - Validaci√≥n y dise√±o mejorado -->
  {% if graficos_brutos %}
  <div class="mt-5">
    <h3 class="text-center mb-4">üìä An√°lisis Exploratorio</h3>
    <div class="row row-cols-1 row-cols-md-2 g-4">
      {% for grafico in graficos_brutos %}
      <div class="col">
        <div class="card h-100 shadow-sm">
          <div class="card-header bg-light">
            <h5 class="card-title text-center mb-0">{{ grafico.titulo }}</h5>
          </div>
          <div class="card-body d-flex justify-content-center">
            <img src="{{ url_for('static', filename='img/' + grafico.nombre_archivo) }}" 
     class="img-fluid p-2 border rounded" 
     alt="{{ grafico.titulo }}"
     style="max-height: 300px;">
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<!-- Bootstrap JS con fallback -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Validaci√≥n cliente del archivo CSV
  document.querySelector('form').addEventListener('submit', function(e) {
    const fileInput = document.getElementById('archivo_entrenamiento');
    if (fileInput.files[0].type !== 'text/csv') {
      e.preventDefault();
      alert('¬°Solo se permiten archivos CSV!');
    }
  });
</script>
{% endblock %}