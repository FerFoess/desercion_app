{% extends "base.html" %}
{% block title %}Carga de Datos de Entrenamiento{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
  <h1 class="text-center mb-4">Carga de Datos de Entrenamiento</h1>

  <!-- Mensajes Flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  {% for category, message in messages %}
  <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endfor %}
  {% endif %}
  {% endwith %}

  <!-- Formulario de carga -->
  <form action="{{ url_for('main.index') }}" method="post" enctype="multipart/form-data" class="card shadow p-4">
    <div class="mb-3">
      <label class="form-label"><strong>📁 Sube el archivo CSV:</strong></label>
      <input type="file" name="archivo_entrenamiento" class="form-control" accept=".csv" required>
    </div>

    <div class="text-center">
      <button type="submit" class="btn btn-primary">Cargar archivo</button>
      <button type="submit" formaction="{{ url_for('main.limpiar_datos') }}" class="btn btn-danger ms-2">Limpiar
        Todo</button>
    </div>
  </form>

  <!-- Tabla de Datos -->
  {% if datos_paginados and columnas %}
  <div class="card shadow mt-5">
    <div class="card-header bg-info text-white fw-bold">
      🧾 Datos del archivo (página {{ pagina_actual }} de {{ total_paginas }})
    </div>
    <div class="card-body table-responsive">
      <table class="table table-striped table-bordered table-hover">
        <thead class="table-dark">
          <tr>
            {% for col in columnas %}
            <th>
              {{ col | capitalize }}
              <small class="text-muted d-block">{{ df[col].dtype if df else '' }}</small>
            </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for fila in datos_paginados %}
          <tr>
            {% for col in columnas %}
            <td>{{ fila.get(col, 'N/A') }}</td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Paginación elegante -->
    {% if total_paginas > 1 %}
    <div class="d-flex justify-content-center mt-4">
      <div class="text-center">
        <small class="text-muted d-block mb-2">
          Página <strong>{{ pagina_actual }}</strong> de <strong>{{ total_paginas }}</strong>
        </small>
        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center pagination-md mb-0">
            <!-- Botón Anterior -->
            <li class="page-item {% if pagina_actual == 1 %}disabled{% endif %}">
              <a class="page-link" href="{{ url_for('main.index', pagina=pagina_actual - 1) }}" aria-label="Anterior">
                &laquo;
              </a>
            </li>

            {% set start = pagina_actual - 2 if pagina_actual - 2 > 1 else 1 %}
            {% set end = start + 4 if start + 4 <= total_paginas else total_paginas %} {% if end - start < 4 and start>
              1 %}
              {% set start = max(1, end - 4) %}
              {% endif %}

              {% for p in range(start, end + 1) %}
              <li class="page-item {% if p == pagina_actual %}active{% endif %}">
                <a class="page-link" href="{{ url_for('main.index', pagina=p) }}">{{ p }}</a>
              </li>
              {% endfor %}

              <!-- Botón Siguiente -->
              <li class="page-item {% if pagina_actual == total_paginas %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('main.index', pagina=pagina_actual + 1) }}"
                  aria-label="Siguiente">
                  &raquo;
                </a>
              </li>
          </ul>
        </nav>
      </div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Gráficos -->
    {% if graficos_brutos %}
    <div class="mt-5">
      <h3 class="text-center mb-4">📊 Análisis Exploratorio</h3>
      <div class="row row-cols-1 row-cols-md-2 g-4">
        {% for grafico in graficos_brutos %}
        <div class="col">
          <div class="flip-card shadow-sm">
            <div class="flip-card-inner">
              <!-- Frente: imagen del gráfico -->
              <div class="flip-card-front border">
                <div class="card-header bg-gradient bg-info text-white fw-semibold">
                  <h5 class="card-title text-center mb-0">{{ grafico.titulo }}</h5>
                </div>
                <div class="card-body d-flex justify-content-center align-items-center">
                  <img src="{{ url_for('static', filename=grafico.nombre_archivo) }}" class="img-fluid p-2"
                    alt="{{ grafico.titulo }}" style="max-height: 250px; width: auto;">
                </div>
              </div>
              <!-- Atrás: interpretación o descripción -->
              <div class="flip-card-back border p-3 d-flex align-items-center justify-content-center">
                <p class="mb-0 text-center">{{ grafico.descripcion }}</p>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Después de la sección de gráficos -->
    {% if datos_paginados %}
    <div class="text-center mt-4">
  
      <a href="{{ url_for('main.predecir') }}" class="btn btn-success btn-lg mt-3">
        🔮 Ir a Predicción
      </a>
    </div>
    {% endif %}

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Validación cliente del archivo CSV
      document.querySelector('form').addEventListener('submit', function (e) {
        const fileInput = document.querySelector('input[name="archivo_entrenamiento"]');
        if (fileInput.files.length > 0 && !fileInput.files[0].name.endsWith('.csv')) {
          e.preventDefault();
          alert('¡Solo se permiten archivos CSV!');
        }
      });
    </script>
    {% endblock %}