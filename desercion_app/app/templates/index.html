{% extends "base.html" %}
{% block title %}Carga de Datos de Entrenamiento{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
  <h1 class="text-center mb-4">Carga de Datos de Entrenamiento</h1>

  <!-- Mensajes Flash -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Formulario de carga -->
  <form action="{{ url_for('main.index') }}" method="post" enctype="multipart/form-data" class="card shadow p-4">
    <div class="mb-3">
      <label class="form-label"><strong>üìÅ Sube el archivo CSV:</strong></label>
      <input type="file" name="archivo_entrenamiento" class="form-control" accept=".csv" required>
    </div>
    
    <div class="text-center">
      <button type="submit" class="btn btn-primary">Cargar archivo</button>
      <button type="submit" formaction="{{ url_for('main.limpiar_datos') }}" class="btn btn-danger ms-2">Limpiar Todo</button>
    </div>
  </form>

  <!-- Tabla de Datos -->
  {% if datos_paginados and columnas %}
  <div class="card shadow mt-5">
    <div class="card-header bg-info text-white fw-bold">
      üßæ Datos del archivo (p√°gina {{ pagina_actual }} de {{ total_paginas }})
    </div>
    <div class="card-body table-responsive">
      <table class="table table-striped table-bordered table-hover">
        <thead class="table-dark">
          <tr>
            {% for col in columnas %}
              <th>
                {{ col | capitalize }}
                <small class="text-muted d-block">{{ df[col].dtype if df else '' }}</small>
              </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for fila in datos_paginados %}
          <tr>
            {% for col in columnas %}
              <td>{{ fila.get(col, 'N/A') }}</td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Paginaci√≥n -->
      {% if total_paginas > 1 %}
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          <li class="page-item {% if pagina_actual == 1 %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('main.index', pagina=pagina_actual - 1) }}">&laquo; Anterior</a>
          </li>
          
          {% for p in range(1, total_paginas + 1) %}
            <li class="page-item {% if p == pagina_actual %}active{% endif %}">
              <a class="page-link" href="{{ url_for('main.index', pagina=p) }}">{{ p }}</a>
            </li>
          {% endfor %}
          
          <li class="page-item {% if pagina_actual == total_paginas %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('main.index', pagina=pagina_actual + 1) }}">Siguiente &raquo;</a>
          </li>
        </ul>
      </nav>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- Gr√°ficos -->
  {% if graficos_brutos %}
  <div class="mt-5">
    <h3 class="text-center mb-4">üìä An√°lisis Exploratorio</h3>
    <div class="row row-cols-1 row-cols-md-2 g-4">
        {% for grafico in graficos_brutos %}
        <div class="col">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title text-center mb-0">{{ grafico.titulo }}</h5>
                </div>
                <div class="card-body d-flex justify-content-center">
                    <img src="{{ url_for('static', filename=grafico.nombre_archivo) }}" 
                         class="img-fluid p-2 border rounded" 
                         alt="{{ grafico.titulo }}"
                         style="max-height: 300px; width: auto;">
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Despu√©s de la secci√≥n de gr√°ficos -->
{% if datos_paginados %}
<div class="text-center mt-4">
  <form action="{{ url_for('main.entrenar') }}" method="post">
    <button type="submit" class="btn btn-primary btn-lg">
      üèãÔ∏è Entrenar Modelo con estos Datos
    </button>
  </form>
  
  <a href="{{ url_for('main.predecir') }}" class="btn btn-success btn-lg mt-3">
    üîÆ Ir a Predicci√≥n
  </a>
</div>
{% endif %}

</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Validaci√≥n cliente del archivo CSV
  document.querySelector('form').addEventListener('submit', function(e) {
    const fileInput = document.querySelector('input[name="archivo_entrenamiento"]');
    if (fileInput.files.length > 0 && !fileInput.files[0].name.endsWith('.csv')) {
      e.preventDefault();
      alert('¬°Solo se permiten archivos CSV!');
    }
  });
</script>
{% endblock %}